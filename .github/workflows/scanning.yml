name: CodeQL Analysis

on:
  workflow_dispatch:

jobs:
  codeql-analysis:
    name: Run CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install CodeQL CLI
        run: |
          # Download CodeQL bundle from the specified GitHub release URL
          wget https://github.com/github/codeql-action/releases/download/codeql-bundle-v2.15.1/codeql-bundle-linux64.tar.gz -O codeql-bundle-linux64.tar.gz
          tar xzf codeql-bundle-linux64.tar.gz -C codeql-extraction
          extraction_root="codeql-extraction/codeql-bundle"

          # Add the CodeQL CLI directory to the PATH
          echo "export PATH=\$PATH:$extraction_root/codeql" >> "$GITHUB_ENV"

      - name: Test CodeQL CLI Configuration
        run: |
          # Verify CodeQL CLI configuration
          codeql resolve qlpacks if "$extraction_root/codeql" is on the PATH.
          "$extraction_root/codeql/codeql" resolve qlpacks otherwise

          # Check available languages
          "$extraction_root/codeql/codeql" resolve languages

      - name: List CodeQL Queries
        id: list-queries
        run: |
          # List all .ql files in the 'queries' directory
          find CodeQL/queries -type f -name "*.ql" > queries-list.txt

      - name: Run CodeQL Analysis
        id: codeql-analysis
        run: |
          # Create a directory for CodeQL results
          mkdir -p codeql-results

          # Loop through each query file listed in 'queries-list.txt'
          while IFS= read -r query_file; do
            # Extract the query file name without the 'CodeQL/queries/' prefix
            query_name=$(basename "$query_file")

            # Clone the repository
            git clone "$url" target-code

            # Run CodeQL analysis on the cloned repository
            "$extraction_root/codeql/codeql" database create target-code-db --language=javascript --command="npm install && npm run build" --source-root=target-code
            "$extraction_root/codeql/codeql" database analyze target-code-db "$query_file" --format=sarif-latest --output=codeql-results/"$query_name-results.sarif"

            # Clean up the cloned repository
            rm -rf target-code
          done < queries-list.txt

      - name: Upload CodeQL Results
        uses: actions/upload-artifact@v2
        with:
          name: codeql-results
          path: codeql-results
